name: Platform Linting and Tests

on:
  workflow_call:
    inputs:
      should-skip-running-and-always-succeed:
        description: "Whether to force the checks to succeed"
        required: false
        type: boolean

jobs:
  platform-linting-and-tests:
    name: Platform Linting and Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    defaults:
      run:
        working-directory: ./platform
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        continue-on-error: ${{ inputs.should-skip-running-and-always-succeed }}
        with:
          working-directory: ./platform

      - name: Setup environment variables
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: cp .env.example .env

      - name: Type checking, linting, formatting checks
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: pnpm check:ci

  platform-e2e-tests:
    name: Platform e2e Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Setup Blacksmith Builder
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: useblacksmith/setup-docker-builder@78f41686563c732ccc097f7baac2f092f67538f0 # v1

      - name: Build Docker image
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: ./platform
          file: ./platform/Dockerfile
          push: false
          load: true
          tags: archestra/platform:ci-test

      - name: Start platform with docker compose
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          docker compose -f ./platform/e2e-tests/docker-compose-platform.yml up -d

          echo "=== Containers started ==="
          docker compose -f ./platform/e2e-tests/docker-compose-platform.yml ps

          echo "=== Waiting for services to initialize (30s) ==="
          sleep 30

          echo "=== Container status after wait ==="
          docker compose -f ./platform/e2e-tests/docker-compose-platform.yml ps

          echo "=== Quick log check for each container ==="
          docker logs archestra-platform-test --tail 50

      - name: Get Playwright version
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform/e2e-tests
        run: |
          echo "PLAYWRIGHT_VERSION=$(cat ./package.json | jq -r '.devDependencies["@playwright/test"]')" >> $GITHUB_ENV

      - name: Cache Playwright binaries and dependencies
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}-chromium

      - name: Install Playwright browsers
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform/e2e-tests
        run: pnpm exec playwright install --with-deps chromium

      - name: Run E2E tests
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform
        run: pnpm test:e2e

      - name: Upload Playwright report
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: platform/e2e-tests/playwright-report/
          retention-days: 30

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker compose -f ./platform/e2e-tests/docker-compose-platform.yml ps

          echo "=== Platform Container Logs ==="
          docker logs archestra-platform-test

          echo "=== PostgreSQL Container Logs ==="
          docker logs archestra-platform-test-postgresql

          echo "=== All Container Stats ==="

          docker stats --no-stream

  helm-chart-linting-and-tests:
    name: Helm Chart Linting and Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    defaults:
      run:
        working-directory: ./platform/helm
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Linting
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: helm lint .

      - name: Tests
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest.git
          helm unittest .

      - name: helm package
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        # NOTE: can't use ${{ github.sha }} for version here because it's not a valid version number
        # and helm package explicitly checks this
        run: |
          helm package . --version v0.0.1 --app-version v0.0.1
