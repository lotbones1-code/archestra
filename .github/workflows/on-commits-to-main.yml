name: On commits to main

on:
  push:
    branches:
      - main

concurrency:
  # Cancel any running workflow when new commits are pushed to main.
  group: on-commits-to-main
  cancel-in-progress: true

jobs:
  build-dev-image:
    name: Build Platform Dev Docker Image
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Authenticate to Google Artifact Registry
        uses: ./.github/actions/auth-to-gar
        with:
          service_account: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_SERVICE_ACCOUNT_NAME }}
          workload_identity_provider: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_WORKLOAD_IDENTITY_PROVIDER_IDENTIFIER }}

      - name: Setup Blacksmith Builder
        uses: useblacksmith/setup-docker-builder@78f41686563c732ccc097f7baac2f092f67538f0 # v1

      - name: Build Docker image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: ./platform
          file: ./platform/Dockerfile
          # NOTE: only build on amd64 for now as our staging environment runs on amd64
          # if we will need to support arm64, we should follow the pattern we do in
          # .github/workflows/build-dockerhub-image.yml and do a matrix build so that we are build
          # on both amd64 and arm64 using native arch (to massively speed up the builds)
          platforms: linux/amd64
          build-args: |
            VERSION=${{ github.sha }}
          push: true
          tags: |
            europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/platform:${{ github.sha }}

  deploy-to-staging:
    name: Deploy to staging
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: build-dev-image
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@6fc4af4b145ae7821d527454aa9bd537d1f2dc5f # v2.1.7
        with:
          service_account: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_SERVICE_ACCOUNT_NAME }}
          workload_identity_provider: ${{ secrets.DEVELOPMENT_OAUTH_PROXY_RELEASER_GCP_WORKLOAD_IDENTITY_PROVIDER_IDENTIFIER }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials archestra-staging \
            --zone us-central1-a \
            --project friendly-path-465518-r6

      - name: Deploy to staging
        run: |
          helm upgrade archestra-platform \
            ./platform/helm \
            --install \
            --namespace archestra \
            --create-namespace \
            --set archestra.image=europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/platform:${{ github.sha }} \
            --set archestra.databaseUrl="${{ secrets.ARCHESTRA_STAGING_DATABASE_URL }}" \
            --wait
